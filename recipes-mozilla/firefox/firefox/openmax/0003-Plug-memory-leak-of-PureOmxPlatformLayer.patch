From 368d58e0f26fc468998ea87cba07e6135e0d2031 Mon Sep 17 00:00:00 2001
From: Takuro Ashie <ashie@clear-code.com>
Date: Tue, 11 Sep 2018 11:38:40 +0900
Subject: [PATCH 3/4] Plug memory leak of PureOmxPlatformLayer

Signed-off-by: Takuro Ashie <ashie@clear-code.com>
---
 dom/media/platforms/omx/PureOmxPlatformLayer.cpp | 10 ++++++++--
 1 file changed, 8 insertions(+), 2 deletions(-)

diff --git a/dom/media/platforms/omx/PureOmxPlatformLayer.cpp b/dom/media/platforms/omx/PureOmxPlatformLayer.cpp
index 35f7aeb..37882bf 100644
--- a/dom/media/platforms/omx/PureOmxPlatformLayer.cpp
+++ b/dom/media/platforms/omx/PureOmxPlatformLayer.cpp
@@ -116,8 +116,6 @@ PureOmxPlatformLayer::PureOmxPlatformLayer(OmxDataDecoder* aDataDecoder,
 PureOmxPlatformLayer::~PureOmxPlatformLayer()
 {
   LOG("");
-  if (mComponent)
-    OMX_FreeHandle(mComponent);
 }
 
 OMX_ERRORTYPE
@@ -270,6 +268,14 @@ nsresult
 PureOmxPlatformLayer::Shutdown()
 {
   LOG("");
+  if (mComponent) {
+    OMX_FreeHandle(mComponent);
+    mComponent = nullptr;
+  }
+  mImageContainer = nullptr;
+  mTaskQueue = nullptr;
+  mPromiseLayer = nullptr;
+  mDataDecoder = nullptr;
   return NS_OK;
 }
 
-- 
2.7.4

